---
title: "EIP平台配置"
weight: 60
description: >
  本文介绍如何配置使用EIP
---

## 什么时候需要EIP？

VPC网络给用户提供了一个隔离的虚拟网络，允许用户配置任意地址段的IP子网，实现VPC内的虚拟机之间通过虚拟网络通信。同时，云平台开启了默认的NAT功能，允许VPC内的虚拟机主动访问VPC外部的网络地址。

然而，当我们希望外部网络能够主动访问VPC内的虚拟机时，就需要使用EIP。EIP的作用就是将物理网络的一个IP地址唯一地映射到VPC里的一个虚拟IP。当外部网络访问该EIP时，自动将流量转发到EIP对应的VPC内虚拟机，实现外部网络主动访问VPC内虚拟机的效果。

## EIP的平台配置

为了让EIP功能正常工作，管理员需要在平台进行相关的配置，大概分为两步：

### 第一步：部署EIP网关

具体步骤请参见[部署EIP网关](./eipgwhowto)

需要说明的是，如果是AllInOne部署，部署的节点已经默认开启了EIP网关功能。因此，部署完成后，只需要做EIP网段的配置。

### 第二步：配置EIP网段

管理员需要在平台配置一个或多个EIP网段用于EIP地址的分配。

云平台配置EIP网段的方法为，在经典网络（Default VPC）创建一个类型为“EIP”的IP子网。可以在前端创建，也可以在后端用climc命令行创建。创建EIP需要使用经典网络，即选择Default VPC，二层网络可选择任意二层网络。

然而，EIP网段不是任意设置的，必须是物理网络中实际可路由的一个IP网段，需要满足如下条件：在物理网络访问EIP网段里任意IP地址的报文都要经过EIP网关。因此需要网络管理员根据EIP网关的网络配置进行相应的配置。

针对AllInOne部署配置，一般来说按如下方法配置路由：在AllInOne节点的接入三层交换机，新增一条静态路由，该路由的目的网段为EIP网段，路由下一跳为AllInOne节点的IP地址。为了避免路由冲突，EIP网段应避免和宿主机所在IP网段重叠。

例如，AllInOne部署节点IP地址为 192.168.201.20/24，选择EIP网段为 192.168.202.1-254/24，则在AllInOne节点的接入三层交换机上配置一条静态路由：

```
Network Prefix      NextHop
192.168.202.0/24    192.168.201.20
```

同时在云平台上配置一个经典网络IP子网，地址范围为：192.168.202.1-192.168.202.254，子网掩码长度24.

### 验证路由配置

可以通过如下方法验证EIP路由是否正确配置：

在物理网络内需要访问EIP的任意节点发起对EIP的ping，然后在EIP网关抓包，看是否能正确收到ping报文。

```bash
tcpdump -i eth0 -nnn host <eip> and icmp
```

## 使用EIP

用户使用EIP的流程为：给指定虚拟机分配一个EIP地址，从外部网络访问该EIP即能实现对虚拟机的访问。该操作可以在前端Web UI操作，也可以后端通过climc命令实现。

```bash
climc server-create-eip --bandwidth <bw_mb> <server_id> 
```
